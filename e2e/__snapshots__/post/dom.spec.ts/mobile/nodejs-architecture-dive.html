<progress
  class="[&amp;::-webkit-progress-bar]:bg-sub-blue fixed top-0 left-0 z-10 w-full h-[3px] appearance-none [&amp;::-webkit-progress-value]:bg-base-og"
  value="0"
  max="1"
></progress>
<nav
  class="fixed z-40 flex flex-wrap w-full justify-between justify-items-center hover:animate-rainbow-water hover:bg-nav hover:bg-[length:400%_400%] opacity-10 md:opacity-100 shadow-nav shadow-lg"
>
  <h2 class="tracking-tight mr-6 text-2xl font-bold my-2 ml-3.5">
    <a class="hover:underline" href="/">1ilsang</a>
  </h2>
  <div class="flex">
    <h2 class="tracking-tight mr-6 text-xl mt-2.5">
      <a class="hover:underline" href="/posts">posts</a>
    </h2>
    <h2 class="tracking-tight mr-6 text-xl mt-2.5">
      <a class="hover:underline" href="/tags">tags</a>
    </h2>
    <div class="mr-2 w-8 h-8 mt-2" role="img" aria-label="1ilsang character">
      <a href="/about"
        ><img
          class="border border-solid rounded-full border-white-blue"
          src="/images/chul.webp"
          alt="1ilsang"
      /></a>
    </div>
  </div>
</nav>
<section
  class="h-auto min-h-full max-w-(--breakpoint-md) py-20 md:py-28 mx-4 min-[790px]:m-auto print:py-0"
>
  <h1 class="text-4xl break-words md:text-6xl">
    Node.js 아키텍처 및 동작 분석
  </h1>
  <section class="flex items-center mt-4">
    <div
      class="mr-2 w-9 h-9 md:w-12 md:h-12"
      role="img"
      aria-label="1ilsang character"
    >
      <a href="/about"
        ><img
          class="border border-solid rounded-full border-sub-blue"
          src="/images/chul.webp"
          alt="1ilsang"
      /></a>
    </div>
    <div>
      <a class="text-lg" href="/about">1ilsang</a>
      <div class="text-sm text-sub-blue">클라이밍 하실래염?</div>
    </div>
  </section>
  <section class="flex flex-wrap items-end mt-2">
    <a
      class="text-highlight print:text-black hover:underline mr-2"
      target="_self"
      href="/tags/nodejs"
      >#<!-- -->nodejs</a
    ><a
      class="text-highlight print:text-black hover:underline mr-2"
      target="_self"
      href="/tags/v8"
      >#<!-- -->v8</a
    ><a
      class="text-highlight print:text-black hover:underline mr-2"
      target="_self"
      href="/tags/libuv"
      >#<!-- -->libuv</a
    ><a
      class="text-highlight print:text-black hover:underline mr-2"
      target="_self"
      href="/tags/undici"
      >#<!-- -->undici</a
    ><a
      class="text-highlight print:text-black hover:underline mr-2"
      target="_self"
      href="/tags/event-loop"
      >#<!-- -->event-loop</a
    >
  </section>
  <section>
    <div class="inline text-date-gray">
      <span class="mr-1">Published</span
      ><time datetime="2025-03-24 21:27">2025-03-24 21:27</time>
    </div>
  </section>
  <section id="post-body-container" class="relative">
    <div class="markdown">
      <div class="img-container">
        <div
          class="flex justify-center mt-3 mb-3 w-full flex-col h-[600px] object-contain bg-transparent mt-10 min-h-[200px]"
        >
          <img
            class="w-full cursor-zoom-in object-contain max-h-[550px]"
            alt="cover"
            src="/posts/nodejs-architecture-dive/cover.webp"
          />
        </div>
      </div>
      <p class="mt-4 mb-4">
        작년
        <a
          href="https://www.oss.kr/notice/show/b6c4ed79-6435-444b-b4b0-debbb041354f"
          class="underline-highlight-fade"
          target="_blank"
          rel="noreferrer noopener"
          >오픈소스 컨트리뷰션 Node.js</a
        >에 참여하면서 노드의 동작 방식을 많이 이해할 수 있었다.
      </p>
      <p class="mt-4 mb-4">
        이번 포스트는 Node.js의 구조와 내부 의존성의 존재의의 및 연결성을 정리해
        보려고 한다.
      </p>
      <p class="mt-4 mb-4">글의 구성은 아래의 3단계를 거쳐나갈 예정이다.</p>
      <ol class="min-[790px]:ml-6 ml-4 list-decimal">
        <li class="my-1.25">Node.js가 무엇인지</li>
        <li class="my-1.25">전체 아키텍처와 구성 요소</li>
        <li class="my-1.25">실제 예제 코드로 동작 흐름 이해</li>
      </ol>
      <br />
      <i>Let's Dive In!</i>
      <h2
        id="tldr"
        class="font-semibold leading-snug pb-0.5 pt-6 mb-2 group text-3xl mt-12 border-b border-[hsl(210deg_18%_87%_/100%)]"
      >
        <a aria-hidden="true" tabindex="-1" href="#tldr"
          ><span
            class="icon icon-link opacity-0 group-hover:opacity-100 ease-in-out transition-opacity duration-300 before:absolute before:w-[40px] before:left-[-25px] before:content-[&quot;⧉&quot;] before:text-[#61768f] before:mr-2"
          ></span></a
        >TL;DR!
      </h2>
      <ol class="min-[790px]:ml-6 ml-4 list-decimal">
        <li class="my-1.25">Node.js는 JavaScript 런타임 "환경"이다.</li>
        <li class="my-1.25">
          V8 엔진과 libuv 라이브러리를 사용하여 비동기, 이벤트 기반의 네트워크
          앱이 되었다.
        </li>
        <li class="my-1.25">내부 모듈은 JS/C++ 페어로 작성되어 있다.</li>
      </ol>
      <h2
        id="nodejs-이해하기"
        class="font-semibold leading-snug pb-0.5 pt-6 mb-2 group text-3xl mt-12 border-b border-[hsl(210deg_18%_87%_/100%)]"
      >
        <a aria-hidden="true" tabindex="-1" href="#nodejs-이해하기"
          ><span
            class="icon icon-link opacity-0 group-hover:opacity-100 ease-in-out transition-opacity duration-300 before:absolute before:w-[40px] before:left-[-25px] before:content-[&quot;⧉&quot;] before:text-[#61768f] before:mr-2"
          ></span></a
        >Node.js 이해하기
      </h2>
      <p class="mt-4 mb-4">
        Node의 구조를 깊이 있게 이해하기 위해 만들어진 배경과 해결하고자 한
        문제를 알아보자. Node.js는 왜/어떻게 탄생했을까?
      </p>
      <h3
        id="당시의-상황"
        class="font-semibold leading-snug pb-0.5 pt-6 mb-2 group text-2xl mt-8"
      >
        <a aria-hidden="true" tabindex="-1" href="#당시의-상황"
          ><span
            class="icon icon-link opacity-0 group-hover:opacity-100 ease-in-out transition-opacity duration-300 before:absolute before:w-[40px] before:left-[-25px] before:content-[&quot;⧉&quot;] before:text-[#61768f] before:mr-2"
          ></span></a
        >당시의 상황
      </h3>
      <div class="img-container">
        <div
          class="flex justify-center mt-3 mb-3 w-full flex-col border rounded min-h-[200px]"
        >
          <img
            class="w-full cursor-zoom-in object-contain max-h-[550px]"
            alt="ryan-dahl"
            src="/posts/nodejs-architecture-dive/ryan-dahl.webp"
          />
        </div>
      </div>
      <blockquote
        class="pl-4 text-[#8b949e] border-l-[0.25rem] border-[#425061]"
      >
        <p class="mt-4 mb-4">
          Node.js: The Documentary | An origin story -
          <a
            href="https://youtu.be/LB8KwiiUGy0?si=MLmed7yFgBQPni1a&amp;t=54"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >YouTube</a
          >
        </p>
      </blockquote>
      <p class="mt-4 mb-4">
        Node.js의 역사는 2009년
        <a
          href="https://en.wikipedia.org/wiki/Ryan_Dahl"
          class="underline-highlight-fade"
          target="_blank"
          rel="noreferrer noopener"
          >Ryan Dahl</a
        >이
        <a
          href="https://www.youtube.com/watch?v=EeYvFl7li9E"
          class="underline-highlight-fade"
          target="_blank"
          rel="noreferrer noopener"
          >JSConf EU 컨퍼런스에서 발표</a
        >하면서 시작되었다. 당시의 상황을 이해해 보자.
      </p>
      <p class="mt-4 mb-4">
        Dahl은 야후의 사진 공유 커뮤니티
        <a
          href="https://en.wikipedia.org/wiki/Flickr"
          class="underline-highlight-fade"
          target="_blank"
          rel="noreferrer noopener"
          >Flickr</a
        >에 파일 업로드 진행이 얼마나 되었는지 알기 위해 서버에 쿼리를 전송하는
        과정을 보고 확장성이 뛰어난 실시간(동시성) 웹 서버에 대해 고민하게 된다.
      </p>
      <p class="mt-4 mb-4">
        당시의 Apache HTTP Server와 같은 환경에선 많은 수의 동시 연결을 처리하는
        데 어려움이 있었다. 리퀘스트 하나당 하나의 컨텍스트, 멀티
        프로세스/쓰레드 방식이므로 다른 컨텍스트에 개입하기 힘들었다. 하나의
        작업이 끝날 때까지 기다리는 것(blocking)이 보편적이었던 시대였다.
      </p>
      <p class="mt-4 mb-4">
        Node는 이 문제에서 탄생했다.
        <u>어떻게 두 가지를 동시에 처리할 수 있을까?</u> 모든 것을 비동기로
        처리하고 IO를 기다리지 않는다면(non-blocking) 어떨까?
      </p>
      <blockquote
        class="pl-4 text-[#8b949e] border-l-[0.25rem] border-[#425061]"
      >
        <p class="mt-4 mb-4">출처:</p>
        <ul class="min-[790px]:ml-6 ml-4 list-disc">
          <li class="my-1.25">
            <a
              href="https://siliconangle.com/2013/04/01/the-birth-of-node-where-did-it-come-from-creator-ryan-dahl-shares-the-history/"
              class="underline-highlight-fade"
              target="_blank"
              rel="noreferrer noopener"
              >The Birth of Node: Where Did it Come From? Creator Ryan Dahl
              Shares the History</a
            >
          </li>
          <li class="my-1.25">
            <a
              href="https://www.almabetter.com/bytes/tutorials/nodejs/introduction-to-nodejs"
              class="underline-highlight-fade"
              target="_blank"
              rel="noreferrer noopener"
              >Introduction to Node JS - History &amp; Features</a
            >
          </li>
          <li class="my-1.25">
            <a
              href="https://en.wikipedia.org/wiki/Node.js"
              class="underline-highlight-fade"
              target="_blank"
              rel="noreferrer noopener"
              >Node.js - Wikipedia</a
            >
          </li>
        </ul>
      </blockquote>
      <h3
        id="nodejs란"
        class="font-semibold leading-snug pb-0.5 pt-6 mb-2 group text-2xl mt-8"
      >
        <a aria-hidden="true" tabindex="-1" href="#nodejs란"
          ><span
            class="icon icon-link opacity-0 group-hover:opacity-100 ease-in-out transition-opacity duration-300 before:absolute before:w-[40px] before:left-[-25px] before:content-[&quot;⧉&quot;] before:text-[#61768f] before:mr-2"
          ></span></a
        >Node.js란?
      </h3>
      <blockquote
        class="pl-4 text-[#8b949e] border-l-[0.25rem] border-[#425061]"
      >
        <p class="mt-4 mb-4">
          As an asynchronous event-driven JavaScript runtime, Node.js is
          designed to build scalable network applications.
        </p>
      </blockquote>
      <p class="mt-4 mb-4">
        <a
          href="https://nodejs.org/en/about"
          class="underline-highlight-fade"
          target="_blank"
          rel="noreferrer noopener"
          >공식 설명</a
        >에서 한 줄 요약이 잘되어 있다. 각 키워드를 가볍게 살펴보자.
      </p>
      <h5
        id="asynchronous"
        class="font-semibold leading-snug pb-0.5 pt-6 mb-2 group text-lg pt-4 mb-0.5"
      >
        <a aria-hidden="true" tabindex="-1" href="#asynchronous"
          ><span
            class="icon icon-link opacity-0 group-hover:opacity-100 ease-in-out transition-opacity duration-300 before:absolute before:w-[40px] before:left-[-25px] before:content-[&quot;⧉&quot;] before:text-[#61768f] before:mr-2"
          ></span></a
        >Asynchronous
      </h5>
      <ul class="min-[790px]:ml-6 ml-4 list-disc">
        <li class="my-1.25">
          <a
            href="https://adrianmejia.com/asynchronous-vs-synchronous-handling-concurrency-in-javascript/"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >비동기</a
          >는 작업을 기다리지 않는다
        </li>
      </ul>
      <h5
        id="event-driven"
        class="font-semibold leading-snug pb-0.5 pt-6 mb-2 group text-lg pt-4 mb-0.5"
      >
        <a aria-hidden="true" tabindex="-1" href="#event-driven"
          ><span
            class="icon icon-link opacity-0 group-hover:opacity-100 ease-in-out transition-opacity duration-300 before:absolute before:w-[40px] before:left-[-25px] before:content-[&quot;⧉&quot;] before:text-[#61768f] before:mr-2"
          ></span></a
        >Event-driven
      </h5>
      <ul class="min-[790px]:ml-6 ml-4 list-disc">
        <li class="my-1.25">
          <a
            href="https://dev.to/iserioton/event-driven-programming-in-nodejs-975"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >이벤트 기반</a
          >은 이벤트 수신(listen)과 발신(emit)으로 작업 완료 타이밍을 알려준다
        </li>
      </ul>
      <h5
        id="javascript-runtime"
        class="font-semibold leading-snug pb-0.5 pt-6 mb-2 group text-lg pt-4 mb-0.5"
      >
        <a aria-hidden="true" tabindex="-1" href="#javascript-runtime"
          ><span
            class="icon icon-link opacity-0 group-hover:opacity-100 ease-in-out transition-opacity duration-300 before:absolute before:w-[40px] before:left-[-25px] before:content-[&quot;⧉&quot;] before:text-[#61768f] before:mr-2"
          ></span></a
        >JavaScript runtime
      </h5>
      <ul class="min-[790px]:ml-6 ml-4 list-disc">
        <li class="my-1.25">
          <a
            href="https://www.freecodecamp.org/news/javascript-engine-and-runtime-explained/"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >자바스크립트 런타임</a
          >은 JavaScript 코드 실행을 가능하게 하는 포괄적인 환경이다
        </li>
      </ul>
      <h5
        id="확장-가능한-네트워크-앱"
        class="font-semibold leading-snug pb-0.5 pt-6 mb-2 group text-lg pt-4 mb-0.5"
      >
        <a aria-hidden="true" tabindex="-1" href="#확장-가능한-네트워크-앱"
          ><span
            class="icon icon-link opacity-0 group-hover:opacity-100 ease-in-out transition-opacity duration-300 before:absolute before:w-[40px] before:left-[-25px] before:content-[&quot;⧉&quot;] before:text-[#61768f] before:mr-2"
          ></span></a
        >확장 가능한 네트워크 앱
      </h5>
      <ul class="min-[790px]:ml-6 ml-4 list-disc">
        <li class="my-1.25">
          Node.js의 이름이
          <a
            href="https://stackoverflow.com/questions/5621812/why-is-node-js-named-node-js"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >"Node"인 이유</a
          >에 해당한다
        </li>
      </ul>
      <p class="mt-4 mb-4">
        즉,
        <u
          >Node.js는 작업을 기다리지 않고 이벤트로 처리하는 JavaScript 런타임
          환경을 제공하는 네트워크 앱</u
        >이다.
      </p>
      <h3
        id="browser와의-차이점"
        class="font-semibold leading-snug pb-0.5 pt-6 mb-2 group text-2xl mt-8"
      >
        <a aria-hidden="true" tabindex="-1" href="#browser와의-차이점"
          ><span
            class="icon icon-link opacity-0 group-hover:opacity-100 ease-in-out transition-opacity duration-300 before:absolute before:w-[40px] before:left-[-25px] before:content-[&quot;⧉&quot;] before:text-[#61768f] before:mr-2"
          ></span></a
        >Browser와의 차이점
      </h3>
      <div class="img-container">
        <div
          class="flex justify-center mt-3 mb-3 w-full flex-col min-h-[200px]"
        >
          <img
            class="w-full cursor-zoom-in object-contain max-h-[550px]"
            alt="browser vs node"
            src="/posts/nodejs-architecture-dive/browser-node.webp"
          />
        </div>
      </div>
      <blockquote
        class="pl-4 text-[#8b949e] border-l-[0.25rem] border-[#425061]"
      >
        <ul class="min-[790px]:ml-6 ml-4 list-disc">
          <li class="my-1.25">
            <a
              href="https://dev.to/shwetabh1/complete-webpage-rendering-process-in-browser-59l1"
              class="underline-highlight-fade"
              target="_blank"
              rel="noreferrer noopener"
              >Complete Webpage Rendering Process In Browser</a
            >
          </li>
          <li class="my-1.25">
            <a
              href="https://chaudharypulkit93.medium.com/how-does-nodejs-work-beginner-to-advanced-event-loop-v8-engine-libuv-threadpool-bbe9b41b5bdd"
              class="underline-highlight-fade"
              target="_blank"
              rel="noreferrer noopener"
              >How does NodeJS work</a
            >
          </li>
        </ul>
      </blockquote>
      <p class="mt-4 mb-4">
        브라우저는
        <a
          href="https://en.wikipedia.org/wiki/World_Wide_Web"
          class="underline-highlight-fade"
          target="_blank"
          rel="noreferrer noopener"
          >WWW</a
        >의 모든 정보를 보고 상호작용할 수 있는 애플리케이션이다(JavaScript는
        페이지의 동적인 작업을 위해 개발된 언어이다). 또한 브라우저는
        <a
          href="https://ko.wikipedia.org/wiki/%EC%83%8C%EB%93%9C%EB%B0%95%EC%8A%A4_(%EC%86%8C%ED%94%84%ED%8A%B8%EC%9B%A8%EC%96%B4_%EA%B0%9C%EB%B0%9C)"
          class="underline-highlight-fade"
          target="_blank"
          rel="noreferrer noopener"
          >샌드박스 환경</a
        >에서 실행되므로 JavaScript로 파일 시스템 접근이나 네트워크 작업에
        제한이 있다.
      </p>
      <p class="mt-4 mb-4">
        <a
          href="https://ko.wikipedia.org/wiki/V8_(%EC%9E%90%EB%B0%94%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8_%EC%97%94%EC%A7%84)"
          class="underline-highlight-fade"
          target="_blank"
          rel="noreferrer noopener"
          >V8 엔진</a
        >이 나타나면서 브라우저 밖에서도 JavaScript를 실행시킬 수 있게 되었다.
        이 덕분에 샌드박스 환경 및 UI와 렌더링 엔진이 없는, 운영 체제와 더
        밀접한 앱들이 등장할 수 있었다. <u>Node.js가 그러한 앱 중 하나</u>이다.
      </p>
      <p class="mt-4 mb-4">
        새로운 앱인 만큼 내부 구현체들도 사뭇 다르다. 대표적인 예로 이벤트
        루프의 구현체를 보면, Chrome에서는
        <a
          href="https://github.com/chromium/chromium/tree/130.0.6706.0/third_party/libevent"
          class="underline-highlight-fade"
          target="_blank"
          rel="noreferrer noopener"
          >libevent</a
        >를 사용(Safari는
        <a
          href="https://github.com/WebKit/WebKit/blob/wpewebkit-2.45.90/Source/WebCore/dom/EventLoop.h#L98"
          class="underline-highlight-fade"
          target="_blank"
          rel="noreferrer noopener"
          >자체 구현</a
        >)하고 있으며 Node.js에서는
        <a
          href="https://libuv.org/"
          class="underline-highlight-fade"
          target="_blank"
          rel="noreferrer noopener"
          >libuv</a
        >를 사용한다.
      </p>
      <blockquote
        class="pl-4 text-[#8b949e] border-l-[0.25rem] border-[#425061]"
      >
        <p class="mt-4 mb-4">
          NOTE&gt; 이벤트 루프의 웹 표준은
          <a
            href="https://en.wikipedia.org/wiki/WHATWG"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >WHATWG</a
          >이
          <a
            href="https://html.spec.whatwg.org/#event-loops"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >권고</a
          >하고 있지만 강제성은 없다.
        </p>
      </blockquote>
      <p class="mt-4 mb-4">
        이와 같은 실행 환경 및 구현체의 차이는 <code>window</code> vs
        <code>global</code> 부터
        <a
          href="https://developer.mozilla.org/en-US/docs/Web/API"
          class="underline-highlight-fade"
          target="_blank"
          rel="noreferrer noopener"
          >WebAPI</a
        >와
        <a
          href="/posts/n-api"
          class="underline-highlight-fade"
          target="_blank"
          rel="noreferrer noopener"
          >N-API</a
        >
        등의 다양한 차이를 만들어냈다.
      </p>
      <h2
        id="아키텍처-살펴보기"
        class="font-semibold leading-snug pb-0.5 pt-6 mb-2 group text-3xl mt-12 border-b border-[hsl(210deg_18%_87%_/100%)]"
      >
        <a aria-hidden="true" tabindex="-1" href="#아키텍처-살펴보기"
          ><span
            class="icon icon-link opacity-0 group-hover:opacity-100 ease-in-out transition-opacity duration-300 before:absolute before:w-[40px] before:left-[-25px] before:content-[&quot;⧉&quot;] before:text-[#61768f] before:mr-2"
          ></span></a
        >아키텍처 살펴보기
      </h2>
      <p class="mt-4 mb-4">
        이제 Node.js의 아키텍처를 확인하고 내부 구현체들을 살펴보자.
      </p>
      <h3
        id="한눈에-보기"
        class="font-semibold leading-snug pb-0.5 pt-6 mb-2 group text-2xl mt-8"
      >
        <a aria-hidden="true" tabindex="-1" href="#한눈에-보기"
          ><span
            class="icon icon-link opacity-0 group-hover:opacity-100 ease-in-out transition-opacity duration-300 before:absolute before:w-[40px] before:left-[-25px] before:content-[&quot;⧉&quot;] before:text-[#61768f] before:mr-2"
          ></span></a
        >한눈에 보기
      </h3>
      <div class="img-container">
        <div
          class="flex justify-center mt-3 mb-3 w-full flex-col border rounded min-h-[200px]"
        >
          <img
            class="w-full cursor-zoom-in object-contain max-h-[550px]"
            alt="node architecture"
            src="/posts/nodejs-architecture-dive/node-architecture.webp"
          />
        </div>
      </div>
      <h3
        id="주요-구성-요소"
        class="font-semibold leading-snug pb-0.5 pt-6 mb-2 group text-2xl mt-8"
      >
        <a aria-hidden="true" tabindex="-1" href="#주요-구성-요소"
          ><span
            class="icon icon-link opacity-0 group-hover:opacity-100 ease-in-out transition-opacity duration-300 before:absolute before:w-[40px] before:left-[-25px] before:content-[&quot;⧉&quot;] before:text-[#61768f] before:mr-2"
          ></span></a
        >주요 구성 요소
      </h3>
      <table class="w-full mb-4 text-[#dfdfdf] break-words">
        <thead>
          <tr>
            <th
              class="text-left text-sm font-normal p-2 border-b border-[#5e5e5e] w-32"
            >
              요소
            </th>
            <th
              class="text-left text-sm font-normal p-2 border-b border-[#5e5e5e]"
            >
              설명
            </th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="text-left text-sm p-2 border-b border-[#5e5e5e]">
              <span
                ><a
                  class="underline-highlight-fade"
                  href="https://github.com/v8/v8/tree/main"
                  target="_blank"
                  rel="noopener noreferrer"
                  >V8</a
                ></span
              ><br />
            </td>
            <td class="text-left text-sm p-2 border-b border-[#5e5e5e]">
              <span
                >- 자바스크립트 코드를 바이트 코드로 변환 및 실행하는 엔진</span
              ><br /><span>
                - 노드에서 V8은 격리(Isolate)된 상태로 구현돼 있으며 자체 메모리
                공간을 가지고 있다</span
              ><br /><span>
                &nbsp;&nbsp;-
                <a
                  class="underline-highlight-fade"
                  href="https://nodejs.org/api/worker_threads.html#worker-threads"
                  target="_blank"
                  rel="noopener noreferrer"
                  >Worker Thread</a
                >가 독립적인 실행이 되는 이유</span
              ><br />
            </td>
          </tr>
          <tr>
            <td class="text-left text-sm p-2 border-b border-[#5e5e5e]">
              <span
                ><a
                  class="underline-highlight-fade"
                  href="https://github.com/libuv/libuv"
                  target="_blank"
                  rel="noopener noreferrer"
                  >libuv</a
                ></span
              ><br />
            </td>
            <td class="text-left text-sm p-2 border-b border-[#5e5e5e]">
              <span
                >- 비동기 I/O,
                <a
                  class="underline-highlight-fade"
                  href="https://nodejs.org/en/learn/asynchronous-work/event-loop-timers-and-nexttick"
                  target="_blank"
                  rel="noopener noreferrer"
                  >이벤트 루프</a
                >, 스레드 풀 등을 제공</span
              ><br /><span>
                - V8에서 처리할 수 없는 작업을 진행(ex. 네트워크, 파일 시스템
                접근 등)</span
              ><br />
            </td>
          </tr>
          <tr>
            <td class="text-left text-sm p-2 border-b border-[#5e5e5e]">
              <span
                ><a
                  class="underline-highlight-fade"
                  href="https://nodejs.org/api/addons.html"
                  target="_blank"
                  rel="noopener noreferrer"
                  >C/C++ Addons</a
                ></span
              ><br />
            </td>
            <td class="text-left text-sm p-2 border-b border-[#5e5e5e]">
              <span
                >- 성능, 확장성 등의 이유로 C/C++ 코드가 필요할 경우 애드온으로
                작성해 노드에서 실행시킬 수 있다</span
              ><br /><span>
                - 노드에서 제공하는
                <a
                  class="underline-highlight-fade"
                  href="/posts/n-api"
                  target="_blank"
                  rel="noopener noreferrer"
                  >Node-API</a
                >
                인터페이스를 활용하면 쉽게 만들 수 있다</span
              ><br />
            </td>
          </tr>
          <tr>
            <td class="text-left text-sm p-2 border-b border-[#5e5e5e]">
              <span
                ><a
                  class="underline-highlight-fade"
                  href="https://nodejs.org/api/modules.html#built-in-modules"
                  target="_blank"
                  rel="noopener noreferrer"
                  >Builtin Modules</a
                ></span
              ><br />
            </td>
            <td class="text-left text-sm p-2 border-b border-[#5e5e5e]">
              <span>- 노드에 내장된 자바스크립트 코드</span><br /><span>
                - 개발자가 직접 사용하는 모듈(fs, path, http 등) 및 내부용
                코드가 존재</span
              ><br />
            </td>
          </tr>
          <tr>
            <td class="text-left text-sm p-2 border-b border-[#5e5e5e]">
              <span>Bindings</span><br />
            </td>
            <td class="text-left text-sm p-2 border-b border-[#5e5e5e]">
              <span>- 자바스크립트 코드에서 사용되는 API를 C++로 구현한 것</span
              ><br /><span>
                - V8, libuv, C/C++ 애드온 등과 연결되는 인터페이스 역할을
                한다</span
              ><br /><span> - 대부분의 모듈이 JS/C++ 페어로 구성되어 있다</span
              ><br />
            </td>
          </tr>
          <tr>
            <td class="text-left text-sm p-2 border-b border-[#5e5e5e]">
              <span>Other Deps</span><br />
            </td>
            <td class="text-left text-sm p-2 border-b border-[#5e5e5e]">
              <span>- Node.js가 의존하는 외부 모듈</span><br />
            </td>
          </tr>
        </tbody>
      </table>
      <h3
        id="동작-흐름"
        class="font-semibold leading-snug pb-0.5 pt-6 mb-2 group text-2xl mt-8"
      >
        <a aria-hidden="true" tabindex="-1" href="#동작-흐름"
          ><span
            class="icon icon-link opacity-0 group-hover:opacity-100 ease-in-out transition-opacity duration-300 before:absolute before:w-[40px] before:left-[-25px] before:content-[&quot;⧉&quot;] before:text-[#61768f] before:mr-2"
          ></span></a
        >동작 흐름
      </h3>
      <div class="img-container">
        <div
          class="flex justify-center mt-3 mb-3 w-full flex-col min-h-[200px]"
        >
          <img
            class="w-full cursor-zoom-in object-contain max-h-[550px]"
            alt="deps"
            src="https://www.mwanmobile.com/wp-content/uploads/2023/01/pp9n3grfwgcaqgi30t4e.gif"
          />
        </div>
      </div>
      <blockquote
        class="pl-4 text-[#8b949e] border-l-[0.25rem] border-[#425061]"
      >
        <p class="mt-4 mb-4">
          <a
            href="https://www.mwanmobile.com/node-js-animated-event-loop"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >https://www.mwanmobile.com/node-js-animated-event-loop</a
          >
        </p>
      </blockquote>
      <figure data-rehype-pretty-code-figure="">
        <pre
          tabindex="0"
          data-language="sh"
          data-theme="material-theme-palenight"
        ><code data-language="sh" data-theme="material-theme-palenight" style="display:grid"><span data-line=""><span style="color:#FFCB6B">$</span><span style="color:#C3E88D"> node</span><span style="color:#C3E88D"> FILE.cjs</span></span></code></pre>
      </figure>
      <ol class="min-[790px]:ml-6 ml-4 list-decimal">
        <li class="my-1.25">
          Node.js는 최초 부트스래핑 이후 유저가 지정한
          애플리케이션(<code>FILE.cjs</code>)의 자바스크립트 코드를 읽어온다.
        </li>
        <li class="my-1.25">
          앱 코드는 <code>V8</code>에서 변환되어 실행 혹은
          <code>Bindings</code> 영역을 거치며 필요한 내부 라이브러리 호출을
          진행한다.
        </li>
        <li class="my-1.25">
          이때 비동기 작업이 필요하다면 <code>libuv</code>로 내부 호출이
          일어나게 된다.
        </li>
        <li class="my-1.25">
          비동기 작업이 완료된다면 이벤트 루프의 페이즈에 맞춰 완료된
          이벤트(<code>callback</code>)가 실행된다.
        </li>
        <li class="my-1.25">
          모든 작업이 완료되면 이벤트 루프가 종료되면서 앱이 종료된다.
        </li>
      </ol>
      <h2
        id="코드로-이해하는-nodejs"
        class="font-semibold leading-snug pb-0.5 pt-6 mb-2 group text-3xl mt-12 border-b border-[hsl(210deg_18%_87%_/100%)]"
      >
        <a aria-hidden="true" tabindex="-1" href="#코드로-이해하는-nodejs"
          ><span
            class="icon icon-link opacity-0 group-hover:opacity-100 ease-in-out transition-opacity duration-300 before:absolute before:w-[40px] before:left-[-25px] before:content-[&quot;⧉&quot;] before:text-[#61768f] before:mr-2"
          ></span></a
        >코드로 이해하는 Node.js
      </h2>
      <p class="mt-4 mb-4">간단한 서버 앱을 통해 노드를 이해해 보자.</p>
      <figure data-rehype-pretty-code-figure="">
        <pre
          tabindex="0"
          data-language="js"
          data-theme="material-theme-palenight"
        ><code data-language="js" data-theme="material-theme-palenight" style="display:grid"><span data-line=""><span style="color:#676E95;font-style:italic">// hello.cjs</span></span>
<span data-line=""><span style="color:#C792EA">const</span><span style="color:#BABED8"> fs </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> require</span><span style="color:#BABED8">(</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">fs</span><span style="color:#89DDFF">'</span><span style="color:#BABED8">)</span><span style="color:#89DDFF">;</span></span>
<span data-line=""><span style="color:#C792EA">const</span><span style="color:#BABED8"> http </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> require</span><span style="color:#BABED8">(</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">http</span><span style="color:#89DDFF">'</span><span style="color:#BABED8">)</span><span style="color:#89DDFF">;</span></span>
<span data-line=""><span style="color:#C792EA">const</span><span style="color:#BABED8"> server </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> http</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">createServer</span><span style="color:#BABED8">()</span><span style="color:#89DDFF">;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#BABED8">server</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">on</span><span style="color:#BABED8">(</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">request</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">,</span><span style="color:#C792EA"> async</span><span style="color:#89DDFF"> (</span><span style="color:#BABED8;font-style:italic">req</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> res</span><span style="color:#89DDFF">)</span><span style="color:#C792EA"> =&gt;</span><span style="color:#89DDFF"> {</span></span>
<span data-line=""><span style="color:#89DDFF;font-style:italic">  if</span><span style="color:#F07178"> (</span><span style="color:#BABED8">req</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">url</span><span style="color:#89DDFF"> ===</span><span style="color:#89DDFF"> '</span><span style="color:#C3E88D">/</span><span style="color:#89DDFF">'</span><span style="color:#F07178">) </span><span style="color:#89DDFF">{</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#BABED8">    fs</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">readFile</span><span style="color:#F07178">(</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">hello.txt</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> '</span><span style="color:#C3E88D">utf-8</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> (</span><span style="color:#BABED8;font-style:italic">err</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> data</span><span style="color:#89DDFF">)</span><span style="color:#C792EA"> =&gt;</span><span style="color:#89DDFF"> {</span></span>
<span data-line=""><span style="color:#C792EA">      const</span><span style="color:#BABED8"> json</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> JSON</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">stringify</span><span style="color:#F07178">(</span><span style="color:#89DDFF">{</span><span style="color:#BABED8"> data</span><span style="color:#89DDFF"> }</span><span style="color:#F07178">)</span><span style="color:#89DDFF">;</span></span>
<span data-line=""><span style="color:#BABED8">      res</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">writeHead</span><span style="color:#F07178">(</span><span style="color:#F78C6C">200</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> {</span><span style="color:#89DDFF"> '</span><span style="color:#F07178">Content-Type</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> '</span><span style="color:#C3E88D">application/json</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF"> }</span><span style="color:#F07178">)</span><span style="color:#89DDFF">;</span></span>
<span data-line=""><span style="color:#BABED8">      res</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">write</span><span style="color:#F07178">(</span><span style="color:#BABED8">json</span><span style="color:#F07178">)</span><span style="color:#89DDFF">;</span></span>
<span data-line=""><span style="color:#BABED8">      res</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">end</span><span style="color:#F07178">()</span><span style="color:#89DDFF">;</span></span>
<span data-line=""><span style="color:#89DDFF">    }</span><span style="color:#F07178">)</span><span style="color:#89DDFF">;</span></span>
<span data-line=""><span style="color:#89DDFF">  }</span></span>
<span data-line=""><span style="color:#89DDFF">}</span><span style="color:#BABED8">)</span><span style="color:#89DDFF">;</span></span>
<span data-line=""><span style="color:#BABED8">server</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">listen</span><span style="color:#BABED8">(</span><span style="color:#F78C6C">3001</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> ()</span><span style="color:#C792EA"> =&gt;</span><span style="color:#BABED8"> console</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">info</span><span style="color:#BABED8">(</span><span style="color:#89DDFF">`</span><span style="color:#C3E88D">Server is running...</span><span style="color:#89DDFF">`</span><span style="color:#BABED8">))</span><span style="color:#89DDFF">;</span></span></code></pre>
      </figure>
      <div class="img-container">
        <div
          class="flex justify-center mt-3 mb-3 w-full flex-col min-[790px]:min-h-[150px] min-[790px]:w-[25%] border rounded min-h-[200px]"
        >
          <img
            class="w-full cursor-zoom-in object-contain max-h-[550px]"
            alt="hello text file"
            src="/posts/nodejs-architecture-dive/hello-txt.webp"
          />
        </div>
      </div>
      <p class="mt-4 mb-4">
        특정 요청이 올 때마다 파일을 읽어 반환하는 코드를 분석해 보자.
      </p>
      <h3
        id="bootstrapping"
        class="font-semibold leading-snug pb-0.5 pt-6 mb-2 group text-2xl mt-8"
      >
        <a aria-hidden="true" tabindex="-1" href="#bootstrapping"
          ><span
            class="icon icon-link opacity-0 group-hover:opacity-100 ease-in-out transition-opacity duration-300 before:absolute before:w-[40px] before:left-[-25px] before:content-[&quot;⧉&quot;] before:text-[#61768f] before:mr-2"
          ></span></a
        >Bootstrapping
      </h3>
      <figure data-rehype-pretty-code-figure="">
        <pre
          tabindex="0"
          data-language="sh"
          data-theme="material-theme-palenight"
        ><code data-language="sh" data-theme="material-theme-palenight" style="display:grid"><span data-line=""><span style="color:#FFCB6B">$</span><span style="color:#C3E88D"> node</span><span style="color:#C3E88D"> hello.cjs</span></span></code></pre>
      </figure>
      <p class="mt-4 mb-4">
        Node.js 또한 애플리케이션이기 때문에 다른 앱과 마찬가지로 실행될 때
        부트스트래핑 과정이 먼저 진행된다.
      </p>
      <div class="img-container">
        <div
          class="flex justify-center mt-3 mb-3 w-full flex-col border rounded min-h-[200px]"
        >
          <img
            class="w-full cursor-zoom-in object-contain max-h-[550px]"
            alt="bootstrapping init"
            src="/posts/nodejs-architecture-dive/bootstrapping-init.webp"
          />
        </div>
      </div>
      <p class="mt-4 mb-4">복잡해 보이지만, 크게 2단계로 나눌 수 있다.</p>
      <ol class="min-[790px]:ml-6 ml-4 list-decimal">
        <li class="my-1.25">
          Node.js 프로세스 시작(C++ Land)<!-- -->
          <ul class="min-[790px]:ml-6 ml-4 list-disc">
            <li class="my-1.25">
              <a
                href="https://github.com/nodejs/node/blob/v22.x/src/node_main.cc#L97"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >main 함수 실행</a
              >
            </li>
            <li class="my-1.25">V8 및 libuv 초기화</li>
            <li class="my-1.25">Realm(실행 컨텍스트) 생성 및 실행 환경 설정</li>
          </ul>
        </li>
        <li class="my-1.25">
          <a
            href="https://github.com/nodejs/node/blob/v22.x/src/node.cc#L440"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >StartExecution</a
          >(JavaScript Land)<!-- -->
          <ul class="min-[790px]:ml-6 ml-4 list-disc">
            <li class="my-1.25">
              <code>run_main_module.js</code> 실행<!-- -->
              <ul class="min-[790px]:ml-6 ml-4 list-disc">
                <li class="my-1.25">
                  여기서
                  <a
                    href="https://github.com/nodejs/node/blob/v22.x/lib/internal/main/run_main_module.js#L15"
                    class="underline-highlight-fade"
                    target="_blank"
                    rel="noreferrer noopener"
                    >엔트리 파일이 실행</a
                  >된다
                </li>
              </ul>
            </li>
            <li class="my-1.25">
              <code>builtins</code> 호출. 노드에 내장된 JS 파일들 실행
            </li>
          </ul>
        </li>
      </ol>
      <p class="mt-4 mb-4">
        여기서 우리는 <code>run_main_module.js</code>를 통해
        <code>hello.cjs</code>가 실행되는 것을 확인할 수 있다. 바로 밑에서
        나오지만, 아직 <u>이벤트 루프가 실행되지 않았다</u>.
      </p>
      <div class="img-container">
        <div
          class="flex justify-center mt-3 mb-3 w-full flex-col border rounded min-h-[200px]"
        >
          <img
            class="w-full cursor-zoom-in object-contain max-h-[550px]"
            alt="bootstrapping event loop"
            src="/posts/nodejs-architecture-dive/bootstrapping-loop.webp"
          />
        </div>
      </div>
      <p class="mt-4 mb-4">
        이후
        <a
          href="https://github.com/nodejs/node/blob/v22.x/src/node_main_instance.cc#L111"
          class="underline-highlight-fade"
          target="_blank"
          rel="noreferrer noopener"
          >SpinEventLoop</a
        >(C++ Land)를 호출해 libuv의 <code>uv_run</code>이 실행되며 이벤트
        루프가 시작된다.
      </p>
      <p class="mt-4 mb-4">
        노드는 부트스트래핑 과정에서 C++과 JavaScript의 경계를 넘나들며
        실행된다. 이 과정은 <code>Bindings</code
        ><a
          class="underline-highlight-fade relative top-[-0.1rem] px-0.25"
          title="#한눈에-보기"
          href="#한눈에-보기"
          target="_blank"
          rel="noopener noreferrer"
          >⎋</a
        >를 통해 이루어지며 C++에서 JavaScript로, JavaScript에서 C++로 호출이
        가능하다.
      </p>
      <blockquote
        class="pl-4 text-[#8b949e] border-l-[0.25rem] border-[#425061]"
      >
        <p class="mt-4 mb-4">
          NOTE&gt; Node.js는 제공된 파일을 한 번 읽고 이벤트 루프를 실행시킨다.
        </p>
      </blockquote>
      <h3
        id="requestsocket-listen"
        class="font-semibold leading-snug pb-0.5 pt-6 mb-2 group text-2xl mt-8"
      >
        <a aria-hidden="true" tabindex="-1" href="#requestsocket-listen"
          ><span
            class="icon icon-link opacity-0 group-hover:opacity-100 ease-in-out transition-opacity duration-300 before:absolute before:w-[40px] before:left-[-25px] before:content-[&quot;⧉&quot;] before:text-[#61768f] before:mr-2"
          ></span></a
        >Request(Socket) listen
      </h3>
      <figure data-rehype-pretty-code-figure="">
        <pre
          tabindex="0"
          data-language="js"
          data-theme="material-theme-palenight"
        ><code data-language="js" data-theme="material-theme-palenight" style="display:grid"><span data-line=""><span style="color:#BABED8">server</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">on</span><span style="color:#BABED8">(</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">request</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> ...</span><span style="color:#BABED8">)</span><span style="color:#89DDFF">;</span></span></code></pre>
      </figure>
      <p class="mt-4 mb-4">
        이벤트 루프의
        <a
          href="https://github.com/nodejs/node/blob/v22.x/deps/uv/src/unix/core.c#L458"
          class="underline-highlight-fade"
          target="_blank"
          rel="noreferrer noopener"
          >poll phase에서</a
        >
        유저의 요청(<code>localhost:3001/</code>)을 인지<a
          class="underline-highlight-fade relative top-[-0.1rem] px-0.25"
          title="https://github.com/nodejs/node/blob/v22.x/src/tcp_wrap.cc#L286"
          href="https://github.com/nodejs/node/blob/v22.x/src/tcp_wrap.cc#L286"
          target="_blank"
          rel="noopener noreferrer"
          >⎋</a
        >한다. 콜백 이벤트를 실행시켜야 하므로 C++ TCP Land에서 JavaScript
        Land로 이동해야 한다.
      </p>
      <p class="mt-4 mb-4">
        이 과정은 Binding 함수인 <code>HTTPParser</code>을 이용한다.
      </p>
      <ol class="min-[790px]:ml-6 ml-4 list-decimal">
        <li class="my-1.25">
          <a
            href="https://github.com/nodejs/node/blob/v22.x/lib/_http_server.js#L564"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >새로운 연결</a
          >이 될 때마다
          <a
            href="https://github.com/nodejs/node/blob/v22.x/lib/_http_common.js#L159"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >HTTPParser 객체가 생성</a
          >된다.
        </li>
        <li class="my-1.25">
          <code>HTTPParser</code> 객체는
          <a
            href="https://github.com/nodejs/node/blob/v22.x/src/node_http_parser.cc#L1398"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >C++ 코드에서 Binding</a
          >
          하고 있다.
        </li>
        <li class="my-1.25">
          작업이 완료되면
          <a
            href="https://github.com/nodejs/node/blob/v22.x/src/connection_wrap.cc#L73"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >콜백이 실행</a
          >된다.
        </li>
      </ol>
      <h3
        id="file-io"
        class="font-semibold leading-snug pb-0.5 pt-6 mb-2 group text-2xl mt-8"
      >
        <a aria-hidden="true" tabindex="-1" href="#file-io"
          ><span
            class="icon icon-link opacity-0 group-hover:opacity-100 ease-in-out transition-opacity duration-300 before:absolute before:w-[40px] before:left-[-25px] before:content-[&quot;⧉&quot;] before:text-[#61768f] before:mr-2"
          ></span></a
        >File I/O
      </h3>
      <figure data-rehype-pretty-code-figure="">
        <pre
          tabindex="0"
          data-language="js"
          data-theme="material-theme-palenight"
        ><code data-language="js" data-theme="material-theme-palenight" style="display:grid"><span data-line=""><span style="color:#BABED8">server</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">on</span><span style="color:#BABED8">(</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">request</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">,</span><span style="color:#C792EA"> async</span><span style="color:#89DDFF"> (</span><span style="color:#BABED8;font-style:italic">req</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> res</span><span style="color:#89DDFF">)</span><span style="color:#C792EA"> =&gt;</span><span style="color:#89DDFF"> {</span></span>
<span data-line=""><span style="color:#676E95;font-style:italic">  // ...</span></span>
<span data-line=""><span style="color:#BABED8">    fs</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">readFile</span><span style="color:#F07178">(</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">hello.txt</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> '</span><span style="color:#C3E88D">utf-8</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> (</span><span style="color:#BABED8;font-style:italic">err</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> data</span><span style="color:#89DDFF">)</span><span style="color:#C792EA"> =&gt;</span><span style="color:#89DDFF"> {</span></span></code></pre>
      </figure>
      <p class="mt-4 mb-4">
        위에서 소켓 연결과 콜백 실행을 확인했었다. <code>request</code> 콜백
        내부에는 파일을 읽는 코드가 있다.
      </p>
      <p class="mt-4 mb-4">
        V8은 파일 작업을 할 수 없기 때문에 libuv가 필요하다.
      </p>
      <ol class="min-[790px]:ml-6 ml-4 list-decimal">
        <li class="my-1.25">
          콜백 실행 도중 bindings 영역을 거쳐 다시
          <a
            href="https://github.com/nodejs/node/blob/v22.x/src/node_file.cc#L2535-L2536"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >libuv에 파일 읽기를 요청</a
          >하게 된다.
        </li>
        <li class="my-1.25">
          libuv는 파일이 완료되면
          <a
            href="https://github.com/nodejs/node/blob/v22.x/deps/uv/src/unix/fs.c#L143-L147"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >이벤트 루프(poll phase)에 결과를 전달</a
          >한다.
        </li>
        <li class="my-1.25">
          이후
          <a
            href="https://github.com/nodejs/node/blob/v22.x/src/node_file.cc#L806"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >AfterInteger</a
          >
          함수를 통해 libuv에서 전달받은 값을 기반으로
          <code>readFile</code> 콜백을 실행하게 된다.
        </li>
      </ol>
      <h3
        id="response"
        class="font-semibold leading-snug pb-0.5 pt-6 mb-2 group text-2xl mt-8"
      >
        <a aria-hidden="true" tabindex="-1" href="#response"
          ><span
            class="icon icon-link opacity-0 group-hover:opacity-100 ease-in-out transition-opacity duration-300 before:absolute before:w-[40px] before:left-[-25px] before:content-[&quot;⧉&quot;] before:text-[#61768f] before:mr-2"
          ></span></a
        >Response
      </h3>
      <figure data-rehype-pretty-code-figure="">
        <pre
          tabindex="0"
          data-language="js"
          data-theme="material-theme-palenight"
        ><code data-language="js" data-theme="material-theme-palenight" style="display:grid"><span data-line=""><span style="color:#BABED8">fs</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">readFile</span><span style="color:#BABED8">(</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">hello.txt</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> '</span><span style="color:#C3E88D">utf-8</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> (</span><span style="color:#BABED8;font-style:italic">err</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> data</span><span style="color:#89DDFF">)</span><span style="color:#C792EA"> =&gt;</span><span style="color:#89DDFF"> {</span></span>
<span data-line=""><span style="color:#676E95;font-style:italic">  // ...</span></span>
<span data-line=""><span style="color:#BABED8">  res</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">write</span><span style="color:#F07178">(</span><span style="color:#BABED8">json</span><span style="color:#F07178">)</span><span style="color:#89DDFF">;</span></span>
<span data-line=""><span style="color:#BABED8">  res</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">end</span><span style="color:#F07178">()</span><span style="color:#89DDFF">;</span></span>
<span data-line=""><span style="color:#89DDFF">}</span><span style="color:#BABED8">)</span><span style="color:#89DDFF">;</span></span></code></pre>
      </figure>
      <p class="mt-4 mb-4">
        <code>readFile</code> 콜백을 실행하면 파일을 읽은 결과를
        <code>res</code> 객체에 담아 클라이언트에게 응답을 보내게 된다.
      </p>
      <p class="mt-4 mb-4">
        마찬가지로 V8은 네트워크 작업을 할 수 없기 때문에 libuv가 필요하다.
      </p>
      <ol class="min-[790px]:ml-6 ml-4 list-decimal">
        <li class="my-1.25">
          <p class="mt-4 mb-4"><code>res.write</code></p>
          <ul class="min-[790px]:ml-6 ml-4 list-disc">
            <li class="my-1.25">
              ServerResponse 함수를 호출하고 해당 함수는
              <a
                href="https://github.com/nodejs/node/blob/v22.x/lib/_http_server.js#L197"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >OutgoingMessage를 상속</a
              >한다.
            </li>
            <li class="my-1.25">
              OutgoingMessage에
              <a
                href="https://github.com/nodejs/node/blob/v22.x/lib/_http_outgoing.js#L898"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >write 함수가 구현</a
              >되어 있다.
            </li>
            <li class="my-1.25">
              함수를 타고 들어가다 보면 결국
              <a
                href="https://github.com/nodejs/node/blob/v22.x/lib/_http_outgoing.js#L443"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >conn.write</a
              >
              함수를 호출한다.
            </li>
            <li class="my-1.25">
              <code>conn</code>은
              <a
                href="https://github.com/nodejs/node/blob/v22.x/lib/net.js#L367"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >net.Socket</a
              >을 의미하는데, 양방향 스트리밍인
              <a
                href="https://github.com/nodejs/node/blob/v22.x/lib/net.js#L521"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >stream.Duplex을 상속</a
              >받고 있다.
            </li>
            <li class="my-1.25">
              <a
                href="https://github.com/nodejs/node/blob/v22.x/lib/internal/streams/duplex.js#L57"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >Duplex는 Writable을 상속</a
              >
              받고 있기 때문에 결국 최종적으로
              <a
                href="https://github.com/nodejs/node/blob/v22.x/lib/internal/streams/writable.js#L504"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >Writable.prototype.write</a
              >를 호출하게 된다.<!-- -->
              <ul class="min-[790px]:ml-6 ml-4 list-disc">
                <li class="my-1.25">
                  <code
                    >conn.write === Stream.Writable.prototype.write //
                    true</code
                  >로 확인할 수 있다.
                </li>
              </ul>
            </li>
            <li class="my-1.25">
              Writable.write는
              <a
                href="https://github.com/nodejs/node/blob/v22.x/lib/internal/streams/writable.js#L587"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >doWrite</a
              >
              함수를 호출하며 Socket의
              <a
                href="https://github.com/nodejs/node/blob/v22.x/lib/net.js#L977"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >_writev 함수</a
              >를 호출한다.
            </li>
            <li class="my-1.25">
              _write 함수는
              <a
                href="https://github.com/nodejs/node/blob/main/lib/internal/stream_base_commons.js#L137"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >C++ 레이어의 writev를 호출</a
              >하고 바인딩된
              <a
                href="https://github.com/nodejs/node/blob/main/src/stream_base.cc#L180"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >StreamBase::Writev</a
              >
              함수는
              <a
                href="https://github.com/nodejs/node/blob/main/src/stream_base.cc#L96"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >DoTryWrite를 호출</a
              >해 최종적으로 libuv의
              <a
                href="https://github.com/nodejs/node/blob/main/src/stream_wrap.cc#L362"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >uv_try_write를 호출</a
              >하게 된다.
            </li>
            <li class="my-1.25">
              이로써 V8이 아닌 C++ 레이어에서 libuv를 통해 네트워크 작업을
              진행하게 된다.
            </li>
          </ul>
        </li>
        <li class="my-1.25">
          <p class="mt-4 mb-4"><code>res.end</code></p>
          <ul class="min-[790px]:ml-6 ml-4 list-disc">
            <li class="my-1.25">
              res.write와 같다. Writable.end를 상속하고 있다.
            </li>
            <li class="my-1.25">
              Writable.end 함수는
              <a
                href="https://github.com/nodejs/node/blob/v22.x/lib/internal/streams/writable.js#L845"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >finishMaybe 함수를 호출</a
              >한다.
            </li>
            <li class="my-1.25">
              함수를 타고 가면
              <a
                href="https://github.com/nodejs/node/blob/v22.x/lib/internal/streams/writable.js#L916"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >stream._final을 호출</a
              >한다.
            </li>
            <li class="my-1.25">
              <code>this</code>는 <code>Socket</code>이므로
              <a
                href="https://github.com/nodejs/node/blob/v22.x/lib/net.js#L535"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >Socket._final을 호출</a
              >하게 된다.
            </li>
            <li class="my-1.25">
              _final은
              <a
                href="https://github.com/nodejs/node/blob/v22.x/lib/net.js#L551"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >_handle.shutdown</a
              >을 호출하면서 C++ 레이어로 넘어간다.<!-- -->
              <ul class="min-[790px]:ml-6 ml-4 list-disc">
                <li class="my-1.25">
                  <a
                    href="https://github.com/nodejs/node/blob/v22.x/lib/net.js#L179"
                    class="underline-highlight-fade"
                    target="_blank"
                    rel="noreferrer noopener"
                    >_handle은 TCP 혹은 Pipe이다</a
                  >.
                </li>
              </ul>
            </li>
            <li class="my-1.25">
              C++ 레이어의 StreamBase::Shutdown은
              <a
                href="https://github.com/nodejs/node/blob/v22.x/src/stream_base.cc#L61"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >DoShutdown을 호출</a
              >하여
              <a
                href="https://github.com/nodejs/node/blob/main/src/stream_wrap.cc#L338"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >libuv를 호출(uv_shutdown)</a
              >한다.
            </li>
            <li class="my-1.25">
              uv_shutdown가 정상적으로 끝나면
              <a
                href="https://github.com/nodejs/node/blob/main/src/stream_wrap.cc#L342"
                class="underline-highlight-fade"
                target="_blank"
                rel="noreferrer noopener"
                >AfterUvShutdown</a
              >이 호출되면서 마무리된다.
            </li>
          </ul>
        </li>
      </ol>
      <h2
        id="마무리"
        class="font-semibold leading-snug pb-0.5 pt-6 mb-2 group text-3xl mt-12 border-b border-[hsl(210deg_18%_87%_/100%)]"
      >
        <a aria-hidden="true" tabindex="-1" href="#마무리"
          ><span
            class="icon icon-link opacity-0 group-hover:opacity-100 ease-in-out transition-opacity duration-300 before:absolute before:w-[40px] before:left-[-25px] before:content-[&quot;⧉&quot;] before:text-[#61768f] before:mr-2"
          ></span></a
        >마무리
      </h2>
      <p class="mt-4 mb-4">
        이번 포스트에서는 Node.js의 아키텍처와 동작 방식을 살펴보았다.
      </p>
      <ul class="min-[790px]:ml-6 ml-4 list-disc">
        <li class="my-1.25">
          Node.js는 V8 엔진과 libuv 라이브러리를 사용하여 비동기, 이벤트 기반의
          네트워크 애플리케이션을 만들 수 있는 JavaScript 런타임 환경이다.
        </li>
        <li class="my-1.25">
          C/C++ 애드온을 통해 성능과 확장성을 높일 수 있으며, 다양한 내장 모듈을
          제공하여 개발자들이 쉽게 사용할 수 있도록 돕는다.
        </li>
      </ul>
      <p class="mt-4 mb-4">
        꽤나 어려운 내용이었지만, 노드의 동작 방식을 이해하는 데 도움이 되었기를
        바란다.
      </p>
      <p class="mt-4 mb-4">다이빙 과정이 흥미로웠다면 아래의 글도 추천한다.</p>
      <ul class="min-[790px]:ml-6 ml-4 list-disc">
        <li class="my-1.25">
          <a
            href="/posts/array-prototype-sort"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >Array.prototype.sort() 이해하기</a
          >
        </li>
        <li class="my-1.25">
          <a
            href="/posts/vite-dev-server"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >Vite Dev Server 이해하기 (feat. HMR)</a
          >
        </li>
        <li class="my-1.25">
          <a
            href="/posts/typescript-subtyping"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >Object.keys()는 왜 string[] 타입일까?</a
          >
        </li>
        <li class="my-1.25">
          <a
            href="/posts/object-type"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >Object vs object vs {}</a
          >
        </li>
        <li class="my-1.25">
          <a
            href="/posts/implicit-coercion"
            class="underline-highlight-fade"
            target="_blank"
            rel="noreferrer noopener"
            >알랑말랑 암묵적 형변환 말랑말랑 이해하기</a
          >
        </li>
      </ul>
    </div>
    <aside
      class="absolute top-0 inline-block h-full break-words left-full max-xl:hidden"
      aria-label="index"
    >
      <ul
        class="ml-9 sticky pl-4 top-32 w-[calc(50vw-35vw)] border-l-2 border-l-base min-[1320px]:ml-20 min-[1320px]:top-48"
      >
        <li
          id="tldr"
          class="pt-0.5 text-base select-none cursor-pointer mb-0.5 hover:text-sub-blue"
        >
          TL;DR!
        </li>
        <li
          id="nodejs-이해하기"
          class="pt-0.5 text-base select-none cursor-pointer mb-0.5 hover:text-sub-blue"
        >
          Node.js 이해하기
        </li>
        <li
          id="당시의-상황"
          class="pt-0.5 text-base select-none cursor-pointer before:content-['-'] before:mr-1 ml-2.5 hover:text-sub-blue"
        >
          당시의 상황
        </li>
        <li
          id="nodejs란"
          class="pt-0.5 text-base select-none cursor-pointer before:content-['-'] before:mr-1 ml-2.5 hover:text-sub-blue"
        >
          Node.js란?
        </li>
        <li
          id="browser와의-차이점"
          class="pt-0.5 text-base select-none cursor-pointer before:content-['-'] before:mr-1 ml-2.5 mb-1.5 hover:text-sub-blue"
        >
          Browser와의 차이점
        </li>
        <li
          id="아키텍처-살펴보기"
          class="pt-0.5 text-base select-none cursor-pointer mb-0.5 hover:text-sub-blue"
        >
          아키텍처 살펴보기
        </li>
        <li
          id="한눈에-보기"
          class="pt-0.5 text-base select-none cursor-pointer before:content-['-'] before:mr-1 ml-2.5 hover:text-sub-blue"
        >
          한눈에 보기
        </li>
        <li
          id="주요-구성-요소"
          class="pt-0.5 text-base select-none cursor-pointer before:content-['-'] before:mr-1 ml-2.5 hover:text-sub-blue"
        >
          주요 구성 요소
        </li>
        <li
          id="동작-흐름"
          class="pt-0.5 text-base select-none cursor-pointer before:content-['-'] before:mr-1 ml-2.5 mb-1.5 hover:text-sub-blue"
        >
          동작 흐름
        </li>
        <li
          id="코드로-이해하는-nodejs"
          class="pt-0.5 text-base select-none cursor-pointer mb-0.5 hover:text-sub-blue"
        >
          코드로 이해하는 Node.js
        </li>
        <li
          id="bootstrapping"
          class="pt-0.5 text-base select-none cursor-pointer before:content-['-'] before:mr-1 ml-2.5 hover:text-sub-blue"
        >
          Bootstrapping
        </li>
        <li
          id="requestsocket-listen"
          class="pt-0.5 text-base select-none cursor-pointer before:content-['-'] before:mr-1 ml-2.5 hover:text-sub-blue"
        >
          Request(Socket) listen
        </li>
        <li
          id="file-io"
          class="pt-0.5 text-base select-none cursor-pointer before:content-['-'] before:mr-1 ml-2.5 hover:text-sub-blue"
        >
          File I/O
        </li>
        <li
          id="response"
          class="pt-0.5 text-base select-none cursor-pointer before:content-['-'] before:mr-1 ml-2.5 mb-1.5 hover:text-sub-blue"
        >
          Response
        </li>
        <li
          id="마무리"
          class="pt-0.5 text-base select-none cursor-pointer mb-0.5 hover:text-sub-blue"
        >
          마무리
        </li>
      </ul>
    </aside>
  </section>
  <a
    class="inline-block text-[#30ffcb] leading-[1.1] after:transition-[width] after:duration-500 ease-in-out hover:after:w-[100%] after:w-0 after:block after:h-[1px] print:text-black print:underline after:bg-[#30ffcb] after:content-[&quot;&quot;] mt-24 [&amp;&amp;]:text-transparent bg-rainbow-water bg-clip-text bg-[length:400%_400%] animate-rainbow-water"
    href="https://github.com/1ilsang/dev/issues/new?labels=🧊 comment&amp;assignees=1ilsang&amp;title=[🧊] Node.js%20%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98%20%EB%B0%8F%20%EB%8F%99%EC%9E%91%20%EB%B6%84%EC%84%9D&amp;body=&lt;!-- 환영합니다. 이슈 남겨주시면 빠르게 답변드리겠습니다. 🙇 --&gt;"
    rel="noopener noreferrer"
    target="_blank"
    >📮 이 포스트에 관심 있으신가요? 이슈를 남겨주세요! 👍</a
  >
  <div class="flex items-center mt-4 mb-56">
    <iframe
      class="border-0 rounded-md cursor-pointer object-contain hover:animate-bouncing"
      src="https://github.com/sponsors/1ilsang/button"
      title="Sponsor 1ilsang"
      height="32"
      width="114"
    ></iframe>
  </div>
</section>
